---
import { getCollection, render, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts
    .filter((post) => !post.data.draft)
    .map((post) => ({
      params: { slug: post.id },
      props: { post },
    }));
}

type Props = {
  post: CollectionEntry<'blog'>;
};

const { post } = Astro.props;
const { Content } = await render(post);

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<BaseLayout title={`${post.data.title} | Hershraj Niranjani`} description={post.data.description}>
  <div class="blog-page">
    <nav class="blog-nav">
      <a href="/#blog" class="back-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5"/>
          <polyline points="12 19 5 12 12 5"/>
        </svg>
        Back to all posts
      </a>
    </nav>

    <article class="blog-full-post">
      <header class="blog-header">
        <div class="blog-header-top">
          <h1>{post.data.title}</h1>
          <button 
            type="button" 
            class="blog-copy-link" 
            data-copy-url={`/blog/${post.id}`}
            title="Copy link to post"
            aria-label="Copy link to post"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
          </button>
        </div>
        <div class="blog-meta">
          <span class="blog-author-name">{post.data.author}</span>
          <span class="blog-meta-separator">Â·</span>
          <time datetime={post.data.pubDate.toISOString()}>
            {formatDate(post.data.pubDate)}
          </time>
          {post.data.updatedDate && (
            <span class="updated">
              (Updated: {formatDate(post.data.updatedDate)})
            </span>
          )}
        </div>
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="blog-tags">
            {post.data.tags.map((tag: string) => (
              <span class="blog-tag">{tag}</span>
            ))}
          </div>
        )}
        <p class="blog-description">{post.data.description}</p>
      </header>

      <div class="blog-body">
        <Content />
      </div>
    </article>

    <br>
    <br>
    
  </div>

  <script>
    // Copy link functionality for full post page
    const copyBtn = document.querySelector('[data-copy-url]');
    if (copyBtn) {
      copyBtn.addEventListener('click', () => {
        const postPath = copyBtn.getAttribute('data-copy-url');
        const url = `${window.location.origin}${postPath}`;

        navigator.clipboard.writeText(url).then(() => {
          copyBtn.classList.add('copied');
          
          // Show tooltip
          const tooltip = document.createElement('span');
          tooltip.className = 'blog-copied-tooltip';
          tooltip.textContent = 'Copied!';
          copyBtn.appendChild(tooltip);

          setTimeout(() => {
            tooltip.classList.add('fade-out');
            setTimeout(() => {
              tooltip.remove();
              copyBtn.classList.remove('copied');
            }, 150);
          }, 1500);
        });
      });
    }
  </script>
</BaseLayout>