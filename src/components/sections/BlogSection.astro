---
import { getCollection, type CollectionEntry } from 'astro:content';
import Section from '../Section.astro';

type BlogPost = CollectionEntry<'blog'>;

// Get all non-draft blog posts, sorted by date ascending (oldest first) for stable ID assignment
const postsByDate: BlogPost[] = (await getCollection('blog'))
  .filter((post: BlogPost) => !post.data.draft)
  .sort((a: BlogPost, b: BlogPost) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf());

// Assign stable IDs starting at 1000 (oldest post = 1000, newer posts get higher IDs)
const postsWithIds = postsByDate.map((post, index) => ({
  post,
  id: 1000 + index,
}));

// Re-sort for display (newest first)
const sortedForDisplay = [...postsWithIds].sort(
  (a, b) => b.post.data.pubDate.valueOf() - a.post.data.pubDate.valueOf()
);

// Posts ready for display (no need to render content inline anymore)
const displayPosts = sortedForDisplay.map(({ post, id }) => ({ post, id }));

// Collect all unique tags
const allTags = [...new Set(postsByDate.flatMap((p) => p.data.tags || []))].sort();

// Helper to format dates nicely
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<Section id="blog" title="Blog">
  <h2>Blog</h2>
  
  {displayPosts.length === 0 ? (
    <p class="no-posts">No posts yet. Check back soon!</p>
  ) : (
    <>
      <div class="blog-filters">
        <div class="blog-search-row">
          <input
            type="search"
            class="blog-search"
            placeholder="Search posts..."
            aria-label="Search blog posts"
          />
          <select class="blog-sort" aria-label="Sort posts">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
          </select>
        </div>
        
        {allTags.length > 0 && (
          <div class="blog-filter-tags">
            <button type="button" class="blog-filter-tag active" data-tag="">All</button>
            {allTags.map((tag) => (
              <button type="button" class="blog-filter-tag" data-tag={tag}>{tag}</button>
            ))}
          </div>
        )}
      </div>

      <div class="blog-posts" data-blog-container>
        {displayPosts.map(({ post, id }) => (
          <article 
            class="blog-post-card"
            id={`post-${id}`}
            data-post-id={id}
            data-title={post.data.title.toLowerCase()}
            data-description={post.data.description.toLowerCase()}
            data-tags={(post.data.tags || []).join(',').toLowerCase()}
            data-date={post.data.pubDate.valueOf()}
          >
            <a href={`/blog/${post.id}`} class="blog-card-link">
              <span class="blog-title">{post.data.title}</span>
              <span class="blog-description">{post.data.description}</span>
            </a>
            <div class="blog-meta">
              <time datetime={post.data.pubDate.toISOString()}>
                {formatDate(post.data.pubDate)}
              </time>
              {post.data.tags && post.data.tags.length > 0 && (
                <span class="blog-tags">
                  {post.data.tags.map((tag: string) => (
                    <button type="button" class="blog-tag" data-tag-click={tag}>{tag}</button>
                  ))}
                </span>
              )}
              <button 
                type="button" 
                class="blog-copy-link" 
                data-copy-link={`/blog/${post.id}`}
                title="Copy link to post"
                aria-label="Copy link to post"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
              </button>
            </div>
          </article>
        ))}
      </div>

      <p class="blog-no-results" hidden>Nothing found... try again?</p>
    </>
  )}
</Section>
